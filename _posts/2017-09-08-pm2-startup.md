---
title:  用pm2来管理node.js进程
date:   2017-09-08 17:46:18
photos:
- https://raw.githubusercontent.com/vincentmrlau/remote-image-store/master/pm2-dashboard.png
categories:
- nodejs
- pm2
tags:
- nodejs
- pm2
excerpt: 用pm2来做进程管理，负载均衡
published: true
---

# 为何选择PM2
> P(rocess)M(anager) 2，一看就知道是做进程管理的，之前都是用`forerver`，一不小心就逛到了PM2,美滋滋。

1. 啥也别说了，看这个截图这个`dashboard`，一副老司机的样子，我喜欢。
2. github 两万 + 的星星，文档很全。
3. 除了我想要的 进程守护，日志，进程管理，还有负载均衡，dashboard。
4. 除了dashboard之外，还有很多管理进程的方法。
5. nodejs的单线程工作在性能上让人诟病，如果在程序中做多线程并发会提高开发成本，如果有这样一个线程管理的工具的话会大大的提高开发效率，同时，也避免了线程阻塞而导致体验上的问题。

# START UP
> [官网的QuickStart: http://pm2.keymetrics.io/docs/usage/quick-start/](http://pm2.keymetrics.io/docs/usage/quick-start/)

# 使用配置文件来管理进程

## 实际的发布需求
1. 面对需要同时存在至少一个开发服务器，一个测试服务器，一个正式服务器这种需求呢，有钱人家的孩子是这样安排的：开发服： 本地主机；测试服：云主机A；正式服：云主机B。而我，开发服：我的小电脑；测试服：云主机A；正式服：云主机A；
2. 这样我就需要同时在云主机A上跑两个环境，然后，也需要在我的小电脑上跑三个环境（另外两个环境要测一下）
3. 每个环境都有好几服务，比如我最近做的一个项目，一个后台服务，一个app服务，一个对象存储服务。

## 面对这个需求的解决办法
> 这么多环境，我的运行办法是设置了一个进程的环境参数，`process.env`，通过这个来区别，这个可以通过参数来设置，也可以通过直接设置。一般的思路就是`pm2 start serveA -- DEV`多次执行就可以启动完成了。但是，pm2提供了一个很棒的方法来集中管理

### 使用PROCESS FILE

> [文档地址](http://pm2.keymetrics.io/docs/usage/application-declaration/#process-file)

> 简单的，用process file来配置好需要启动的进程和对应的参数就可以了，这个文件呢需要以`.config.js`来命名（或者其他的格式），然后`pm2 start pro.config.js`。

```javaScript
let path = require('path')

let bsStartApp = path.join(__dirname, 'bs.start.js')

let startApp = path.join(__dirname, 'start.js')

module.exports = {
	apps: [
		{
			name: 'bsclient-pro',
			script: bsStartApp,
			env: {
				'CHOSEN_ENV': 'pro'
			}
		},
		{
			name: 'app-client-pro',
			script: startApp,
			env: {
				'CHOSEN_ENV': 'pro'
			},
			exec_mode: 'cluster',
			instances: 'max'
		}
	]
}
```

# 其他

1. `pm2 web`：启动一个查看进程参数的服务，启动的时候会告诉我们，从哪个端口可以访问到。用`nginx`做路由或者开放端口就可以了。
2. dashboard来自[https://app.keymetrics.io/](https://app.keymetrics.io/)，按照文档`pm2 link`一下就可以了
3. pmx: 获取更多的报告 [http://stackparse.run/exposing-node-dot-js-process-metrics-using-pm2-and-pmx](http://stackparse.run/exposing-node-dot-js-process-metrics-using-pm2-and-pmx)
4. `pm2 monit` ：监控 进程的资源使用情况，和进程情况，日志等。
5. `cluster`模式： 多线程负载均衡。
